<!--
  MonoGame - Copyright (C) The MonoGame Team
  This file is subject to the terms and conditions defined in
  file 'LICENSE.txt', which is part of this source code package.
-->

<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Add MonoGameContentReference to item type selection in Visual Studio -->
  <ItemGroup>
    <AvailableItemName Include="MonoGameContentReference" />
  </ItemGroup>

  <!-- Get all Mono Game Content References and store them in a list -->
  <ItemGroup>
    <ContentReferences Include="@(MonoGameContentReference)"/>
  </ItemGroup>

  <Target Name="Prepare">
    <PropertyGroup>
      <!-- This is the path where all .xnb files will land, by default Content/-->
      <ContentRootDirectory>Content</ContentRootDirectory>
      <ParentOutputDir>$(ProjectDir)$(ContentRootDirectory)\$(MonoGamePlatform)</ParentOutputDir>
      <ParentIntermediateDir>$(ProjectDir)$(IntermediateOutputPath)</ParentIntermediateDir>

      <MonoGameContentBuilderExe>$(MSBuildExtensionsPath)\MonoGame\v3.0\Tools\MGCB.exe</MonoGameContentBuilderExe>

      <Header>/platform:$(MonoGamePlatform) /outputDir:&quot;$(ParentOutputDir)&quot; /quiet</Header>
    </PropertyGroup>

    <!--  Valid platforms: Windows, Xbox360, WindowsPhone, iOS, Android, Linux, MacOSX, WindowsStoreApp, NativeClient, Ouya, PlayStationMobile, PlayStation4, WindowsPhone8, RaspberryPi -->
    <Error Text="The MonoGamePlatform property is not set"
       Condition="'$(MonoGamePlatform)' == ''" />

    <Error
        Text="MonoGame Content Builder could not be located at '$(MonoGameContentBuilderExe)'"
        Condition="!Exists('$(MonoGameContentBuilderExe)')"
      />

    <MakeDir Directories="$(ParentIntermediateDir)"/>
    <MakeDir Directories="$(ParentOutputDir)"/>
  </Target>

  <Target Name="BuildContent"
        BeforeTargets="PreBuildEvent"
        DependsOnTargets="Prepare">

    <Exec Command="&quot;$(MonoGameContentBuilderExe)&quot; $(Header) /@:&quot;%(ContentReferences.FullPath)&quot; /intermediateDir:&quot;$(ParentIntermediateDir)%(ContentReferences.Filename)&quot; "
          WorkingDirectory="%(ContentReferences.RootDir)%(ContentReferences.Directory)"/>

    <ItemGroup>
      <ExtraContent Include="$(ProjectDir)$(ContentRootDirectory)\$(MonoGamePlatform)\**\*.*" />

      <Content Include="@(ExtraContent->'$(ProjectDir)$(ContentRootDirectory)\$(MonoGamePlatform)\%(RecursiveDir)%(Filename)%(Extension)')" Condition="$(MonoGamePlatform) != 'Android'">
        <Link>$(ContentRootDirectory)\%(ExtraContent.RecursiveDir)%(Filename)%(Extension)</Link>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </Content>

      <AndroidAsset Include="@(ExtraContent->'$(ProjectDir)$(ContentRootDirectory)\$(MonoGamePlatform)\%(RecursiveDir)%(Filename)%(Extension)')" Condition="$(MonoGamePlatform) == 'Android'">
        <Link>Assets\$(ContentRootDirectory)\%(ExtraContent.RecursiveDir)%(Filename)%(Extension)</Link>
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      </AndroidAsset>
    </ItemGroup>

    <Message Text="@(ExtraContent->'$(ContentRootDirectory)\%(RecursiveDir)%(FileName)%(Extension)')"/>

  </Target>

  <Target Name="RebuildContent"
          BeforeTargets="Rebuild"
          DependsOnTargets="Prepare">
    <Exec Command="&quot;$(MonoGameContentBuilderExe)&quot; $(Header) /@:&quot;%(ContentReferences.FullPath)&quot; /intermediateDir:&quot;$(ParentIntermediateDir)%(ContentReferences.Filename)&quot; /rebuild "
          WorkingDirectory="%(ContentReferences.RootDir)%(ContentReferences.Directory)"/>
  </Target>

  <Target Name="CleanContent"
          BeforeTargets="Clean"
          DependsOnTargets="Prepare">

    <Exec Command="&quot;$(MonoGameContentBuilderExe)&quot; $(Header) /intermediateDir:&quot;$(ParentIntermediateDir)%(ContentReferences.Filename)&quot;  /clean"
          WorkingDirectory="%(ContentReferences.RootDir)%(ContentReferences.Directory)"
          />
  </Target>

</Project>
